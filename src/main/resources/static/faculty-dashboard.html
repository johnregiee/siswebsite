<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Faculty Dashboard</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Add your CSS file -->
</head>
<body>
    <h1>Faculty Dashboard</h1>
    <p>Welcome, Faculty Member!</p>
    <hr>

    <h3>My Courses</h3>
    <label for="courseSelect">Select a Course to View Roster:</label>
    <select id="courseSelect">
        <option value="">-- Please select a course --</option>
    </select>

    <h3 style="margin-top: 30px;">Student Roster</h3>
    <p id="roster-feedback"></p>
    <table border="1" style="width:100%;">
        <thead>
            <tr>
                <th>Student ID</th>
                <th>Course Code</th>
                <!-- We will add more student details later -->
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="rosterTableBody">
            <!-- Student roster will be loaded here -->
        </tbody>
    </table>

    <script>
        $(document).ready(function() {
            const facultyId = sessionStorage.getItem("facultyId");
            if (!facultyId) {
                alert("Not logged in!");
                window.location.href = "login.html";
            }

            // --- 1. Load the faculty's assigned courses into the dropdown ---
            async function loadFacultyCourses() {
                const courseSelect = $('#courseSelect');
                try {
                    const response = await fetch(`http://localhost:8080/api/schedules/faculty/${facultyId}`);
                    const courses = await response.json();

                    courses.forEach(course => {
                        const option = `<option value="${course.courseCode}" data-coursename="${course.courseName}">${course.courseCode} - ${course.courseName}</option>`;
                        courseSelect.append(option);
                    });
                } catch (error) {
                    console.error("Failed to load courses:", error);
                }
            }

            // --- 2. Load the student roster when a course is selected ---
            $('#courseSelect').on('change', async function() {
                const courseCode = $(this).val();
                const tableBody = $('#rosterTableBody');
                const feedback = $('#roster-feedback');

                tableBody.empty(); // Clear previous roster
                
                if (!courseCode) {
                    feedback.text('');
                    return;
                }
                
                feedback.text('Loading roster...');

                try {
                    const response = await fetch(`http://localhost:8080/api/enrollments/course/${courseCode}`);
                    const enrollments = await response.json();
                    
                    if (enrollments.length === 0) {
                        feedback.text('No students are enrolled in this course.');
                        return;
                    }
                    
                    feedback.text(''); // Clear "loading" message
                    
                    enrollments.forEach(enrollment => {
                        const row = `
                            <tr>
                                <td>${enrollment.studentId}</td>
                                <td>${enrollment.courseCode}</td>
                                <td>
                                    <button class="add-grade-btn" 
                                            data-studentid="${enrollment.studentId}" 
                                            data-coursecode="${enrollment.courseCode}">
                                        Add/Edit Grade
                                    </button>
                                </td>
                            </tr>
                        `;
                        tableBody.append(row);
                    });

                } catch (error) {
                    feedback.text('Failed to load roster.');
                    console.error("Roster error:", error);
                }
            });

            // Initial load of the courses
            loadFacultyCourses();
        });
    </script>
</body>
</html>