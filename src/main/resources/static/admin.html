<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="admin.css" />
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,600,700&display=swap" rel="stylesheet">
    <style>
    /* ... existing styles ... */
    /* Responsive wrapper for horizontal scrolling */
    .curriculum-table-responsive {
        width: 100%;
        overflow-x: auto;
    }
    #curriculumSubjectsTable {
        width: 100%;
        table-layout: fixed;
        border-collapse: separate;
        border-spacing: 0;
        min-width: 900px;
    }
    #curriculumSubjectsTable th, #curriculumSubjectsTable td {
        padding: 12px 8px;
        vertical-align: middle;
        text-align: left;
        background: #fff;
        color: #222;
        word-break: break-word;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    #curriculumSubjectsTable th {
        background: #ffeaea;
        color: #e85743;
        font-weight: 600;
        text-align: left;
        vertical-align: middle;
    }
    #curriculumSubjectsTable th:nth-child(1), #curriculumSubjectsTable td:nth-child(1) { width: 110px; }
    #curriculumSubjectsTable th:nth-child(2), #curriculumSubjectsTable td:nth-child(2) { width: 180px; }
    #curriculumSubjectsTable th:nth-child(3), #curriculumSubjectsTable td:nth-child(3) { width: 60px; text-align: center; }
    #curriculumSubjectsTable th:nth-child(4), #curriculumSubjectsTable td:nth-child(4) { width: 110px; text-align: center; }
    #curriculumSubjectsTable th:nth-child(5), #curriculumSubjectsTable td:nth-child(5) { width: 120px; }
    #curriculumSubjectsTable th:nth-child(6), #curriculumSubjectsTable td:nth-child(6) { width: 110px; }
    #curriculumSubjectsTable th:nth-child(7), #curriculumSubjectsTable td:nth-child(7) { width: 120px; }
    #curriculumSubjectsTable th:nth-child(8), #curriculumSubjectsTable td:nth-child(8) {
        width: 110px;
        text-align: center;
        padding: 0 8px;
    }
    #curriculumSubjectsTable td:nth-child(8) {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 8px;
        background: #fff;
        height: 100%;
        padding: 12px 0;
    }
    #curriculumSubjectsTable td:nth-child(8) button {
        display: block;
        margin: 0 auto;
        min-width: 90px;
        width: 90px;
    }
    @media (max-width: 1100px) {
        .curriculum-table-responsive {
            overflow-x: auto;
        }
        #curriculumSubjectsTable {
            min-width: 900px;
        }
    }
    #schedulesTableBody th, #schedulesTableBody td {
        padding: 10px 8px;
        vertical-align: middle;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    #schedulesTableBody th {
        background: #ffeaea;
        color: #e85743;
        font-weight: 600;
    }
    #schedulesTableBody td {
        background: #fff;
        color: #222;
    }
    #schedulesTableBody th,
    #schedulesTableBody td {
        text-align: left;
    }
    #schedulesTableBody th:nth-child(3),
    #schedulesTableBody td:nth-child(3),
    #schedulesTableBody th:nth-child(4),
    #schedulesTableBody td:nth-child(4) {
        text-align: right;
    }
    #schedulesTableBody th:nth-child(8),
    #schedulesTableBody td:nth-child(8) {
        text-align: center;
        width: 100px;
        max-width: 120px;
        padding: 0 8px;
    }
    #schedulesTableBody td:nth-child(8) {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 6px;
        height: 100%;
        background: #fff;
        padding: 10px 0;
    }
    #schedulesTableBody td:nth-child(8) button {
        margin: 0;
        min-width: 60px;
        width: 80px;
    }
    #schedulesTableBody th:nth-child(2),
    #schedulesTableBody td:nth-child(2) {
        word-break: break-word;
        white-space: normal;
    }
    .schedule-table {
        width: 100%;
        table-layout: fixed;
        border-collapse: collapse;
        min-width: 900px;
    }
    .schedule-table th, .schedule-table td {
        padding: 10px 8px;
        border-bottom: 1px solid #f2dede;
        vertical-align: middle;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .schedule-table th {
        background: #ffeaea;
        font-weight: 600;
        text-align: left;
    }
    .schedule-table th:nth-child(1), .schedule-table td:nth-child(1) { width: 110px; text-align: left; }
    .schedule-table th:nth-child(2), .schedule-table td:nth-child(2) { width: 180px; text-align: left; }
    .schedule-table th:nth-child(3), .schedule-table td:nth-child(3) { width: 60px; text-align: center; }
    .schedule-table th:nth-child(4), .schedule-table td:nth-child(4) { width: 80px; text-align: center; }
    .schedule-table th:nth-child(5), .schedule-table td:nth-child(5) { width: 120px; text-align: center; }
    .schedule-table th:nth-child(6), .schedule-table td:nth-child(6) { width: 120px; text-align: center; }
    .schedule-table th:nth-child(7), .schedule-table td:nth-child(7) { width: 140px; text-align: left; }
    .schedule-table th:nth-child(8), .schedule-table td:nth-child(8) { width: 100px; text-align: center; }
    .schedule-table td .action-buttons {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        justify-content: center;
    }
    .schedule-table td .action-buttons button {
        width: 80px;
        margin: 0 auto;
    }
    @media (max-width: 1100px) {
        .schedule-table { min-width: 900px; }
    }
    </style>
</head>

<body>
    <header class="header">
        <div class="logo">
            <span>PRISM</span>
            <span class="admin-label">Admin</span>
        </div>
        <nav class="nav-tabs">
            <button class="tab-btn" data-tab="faculty">Faculty</button>
            <button class="tab-btn" data-tab="students">Students</button>
            <button class="tab-btn" data-tab="subjects">Subjects</button>
            <button class="tab-btn" data-tab="curriculum">Curriculum</button>
            <!-- <button class="tab-btn" data-tab="accounts">Accounts</button> -->
            <button class="tab-btn" data-tab="courses">Courses</button>
            <button class="tab-btn" data-tab="sections">Sections</button>
            <button class="tab-btn" data-tab="schedules">Schedules</button>
        </nav>
    </header>
    <main class="main-content-wrapper">
        <!-- Faculty Section -->
        <section id="faculty" class="card" style="display:none;">
            <h2>Faculty Management</h2>
            <div id="faculty-feedback" class="feedback"></div>
            <form id="facultyForm" class="card-form">
                <h3>Add New Faculty Member</h3>
                <fieldset>
                    <input type="text" id="facultyName" placeholder="Full Name" required />
                    <input type="email" id="facultyEmail" placeholder="Email" required />
                    <input type="password" id="facultyPassword" placeholder="Password" required />
                    <button type="submit">Create Faculty Account</button>
                </fieldset>
            </form>
            <h3>All Faculty Members</h3>
            <div class="card-table">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Full Name</th>
                            <th>Email</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="facultyTableBody"></tbody>
                </table>
            </div>
        </section>
        <!-- Student Section -->
        <section id="students" class="card" style="display:none;">
            <h2>Student Management</h2>
            <form id="studentForm" class="card-form">
                <h3>Add / Edit Student</h3>
                <fieldset style="display:flex; flex-wrap:wrap; gap: 16px 12px; align-items:center; border:none; padding:0;">
                    <input type="hidden" id="studentId" />
                    <input type="text" id="studentNumber" placeholder="Student Number" required style="flex:1 1 180px; min-width:150px;" pattern="SIS-\d{4}" title="Format: SIS-0000" />
                    <input type="text" id="name" placeholder="Name" required style="flex:1 1 180px; min-width:150px;" />
                    <input type="email" id="email" placeholder="Email" required style="flex:1 1 180px; min-width:150px;" />
                    <input type="password" id="password" placeholder="Password" required style="flex:1 1 180px; min-width:150px;" />
                    <select id="studentCourseSelect" style="flex:1 1 180px; min-width:150px;"><option value="">None</option></select>
                    <select id="studentSectionSelect" style="flex:1 1 180px; min-width:150px;"><option value="">None</option></select>
                    <div style="flex-basis:100%; height:0;"></div>
                    <button type="submit" style="width:250px; min-width:150px; margin-top:8px;">Save Student</button>
                </fieldset>
            </form>
            <h3>All Students</h3>
            <div class="card-table">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Student Number</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Course</th>
                            <th>Section</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="studentTableBody"></tbody>
                </table>
            </div>
        </section>
        <!-- Subject Section -->
        <section id="subjects" class="card" style="display:none;">
            <h2>Subject Management</h2>
            <form id="subjectForm" class="card-form">
                <h3>Add New Subject</h3>
                <fieldset>
                    <input type="hidden" id="subjectId" />
                    <select id="subjectCourseSelect" required>
                        <option value="">Select Course</option>
                    </select>
                    <input type="text" id="subjectCode" placeholder="Subject Code" required />
                    <input type="text" id="subjectName" placeholder="Subject Name" required />
                    <button type="submit">Save Subject</button>
                </fieldset>
            </form>
            <h3>All Subjects</h3>
            <div class="card-table">
                <table>
                    <thead>
                        <tr>
                            <th>Subject Code</th>
                            <th>Subject Name</th>
                            <th>Course</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="subjectTableBody"></tbody>
                </table>
            </div>
        </section>
        <!-- Curriculum Section -->
        <section id="curriculum" class="card" style="display:none;">
            <h2 style="color:#F45B48; font-size:2.5rem; font-weight:700; margin-bottom:1.5rem;">Curriculum Management</h2>
            <form id="createCurriculumForm" class="card-form" style="margin-bottom: 1.5em;">
                <h3>Add / Edit Curriculum</h3>
                <input type="text" id="newCurriculumName" placeholder="Curriculum Name" required style="margin-right: 1em;" />
                <button type="submit" id="saveCurriculumBtn">Save Curriculum</button>
            </form>
            <label for="curriculumPageCurriculumSelect" style="font-weight:600; margin-bottom:0.5em; display:block;">Select Curriculum:</label>
            <select id="curriculumPageCurriculumSelect" style="margin-bottom:1em;"><option value="">Select Curriculum</option></select>
            <h3>All Curriculums</h3>
            <div class="card-table">
                <table>
                    <thead>
                        <tr>
                            <th>Curriculum Name</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="curriculumTableBody"></tbody>
                </table>
            </div>
            <h3 id="curriculumSubjectsHeading">Subjects Under Selected Curriculum</h3>
            <div class="curriculum-table-responsive">
                <table id="curriculumSubjectsTable">
                    <thead>
                        <tr style="background:#ffeaea; color:#e85743;">
                            <th>Subject Code</th>
                            <th>Subject Name</th>
                            <th>Units</th>
                            <th>Room Number</th>
                            <th>Time</th>
                            <th>Day(s)</th>
                            <th>Faculty</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <h4>Add / Edit Subject to Curriculum</h4>
            <form id="curriculumSubjectForm" class="card-form">
                <fieldset style="display:flex; flex-wrap:wrap; gap:16px 12px;">
                    <select id="csCurriculumId" required style="margin-bottom:12px;"><option value="">Select Curriculum</option></select>
                    <select id="csSubjectId" required style="margin-bottom:12px;"><option value="">Select Subject</option></select>
                    <select id="csFacultySelect" style="margin-bottom:12px;"><option value="">Select Faculty</option></select>
                    <input type="number" id="csUnits" placeholder="Units" required min="1" style="margin-bottom:12px;" />
                    <input type="text" id="csRoomNumber" placeholder="Room Number" style="margin-bottom:12px;" />
                    <input type="text" id="csTime" placeholder="Time (e.g., 9:00-10:30)" style="margin-bottom:12px;" />
                    <input type="text" id="csDays" placeholder="Day(s) (e.g., Mon/Wed)" style="margin-bottom:12px;" />
                    <button type="submit" style="margin-bottom:12px;">Save Subject to Curriculum</button>
                </fieldset>
            </form>
        </section>
        <!-- Accounts Section -->
        <section id="accounts" class="card" style="display:none;">
            <h2>Student Accounts</h2>
            <form id="accountForm" class="card-form">
                <h3>Add Student Account</h3>
                <fieldset>
                    <input type="number" id="accountStudentId" placeholder="Student ID" required />
                    <input type="text" id="accountSemester" placeholder="Semester" required />
                    <input type="number" step="0.01" id="accountTuitionFee" placeholder="Tuition Fee" required />
                    <input type="number" step="0.01" id="accountAmountPaid" placeholder="Amount Paid" required />
                    <button type="submit">Add Account</button>
                </fieldset>
            </form>
            <h3>All Student Accounts</h3>
            <div class="card-table">
                <table>
                    <thead>
                        <tr>
                            <th>Account ID</th>
                            <th>Student ID</th>
                            <th>Semester</th>
                            <th>Tuition Fee</th>
                            <th>Amount Paid</th>
                            <th>Balance</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="accountTableBody"></tbody>
                </table>
            </div>
        </section>
        <!-- Courses Section -->
        <section id="courses" class="card" style="display:none;">
            <h2>Course Management</h2>
            <form id="courseForm" class="card-form">
                <h3>Add / Edit Course</h3>
                <fieldset>
                    <input type="hidden" id="courseId">
                    <input type="text" id="courseCode" placeholder="Course Code (e.g., BSIT)" required />
                    <input type="text" id="courseName" placeholder="Course Name (e.g., Information Technology)" required />
                    <button type="submit">Save Course</button>
                </fieldset>
            </form>
            <h3>All Courses</h3>
            <div class="card-table">
                <table>
                    <thead>
                        <tr>
                            <th>Course Code</th>
                            <th>Course Name</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="courseTableBody"></tbody>
                </table>
            </div>
        </section>
        <!-- Sections Section -->
        <section id="sections" class="card" style="display:none;">
            <h2>Section Management</h2>
            <form id="sectionForm" class="card-form">
                <h3>Add New Section</h3>
                <fieldset>
                    <input type="hidden" id="sectionId" />
                    <input type="text" id="sectionName" placeholder="Section Name" required />
                    <button type="submit">Save Section</button>
                </fieldset>
            </form>
            <h3>All Sections</h3>
            <div class="card-table">
                <table>
                    <thead>
                        <tr>
                            <th>Section Name</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="sectionTableBody"></tbody>
                </table>
            </div>
        </section>
        <!-- Schedules Section -->
        <section id="schedules" class="card" style="display:none;">
            <h2>Schedule Management</h2>
            <label for="scheduleCurriculumSelect" style="font-weight:600; margin-bottom:0.5em; display:block;">Select Curriculum:</label>
            <select id="scheduleCurriculumSelect" style="margin-bottom:1em;"><option value="">Select Curriculum</option></select>
            <div class="curriculum-table-responsive">
                <table class="schedule-table">
                    <thead>
                        <tr>
                            <th>Course Code</th>
                            <th>Course Name</th>
                            <th>Units</th>
                            <th>Room</th>
                            <th>Time</th>
                            <th>Day(s)</th>
                            <th>Faculty</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="schedulesTableBody">
                        <!-- Rows rendered by JS -->
                    </tbody>
                </table>
            </div>
            <form id="scheduleForm" class="card-form">
                <h3>Add / Edit Schedule</h3>
                <fieldset>
                    <input type="hidden" id="scheduleId" />
                    <input type="hidden" id="scheduleSubjectId" />
                    <input type="hidden" id="scheduleCurriculumId" />
                    <input type="number" id="scheduleStudentId" placeholder="Student ID" required />
                    <input type="text" id="scheduleCourseCode" placeholder="Course Code" required />
                    <input type="text" id="scheduleCourseName" placeholder="Course Name" required />
                    <input type="text" id="scheduleDay" placeholder="Day(s) (e.g., Mon/Wed)" required />
                    <input type="text" id="scheduleTime" placeholder="Time (e.g., 9:00-10:30)" required />
                    <input type="text" id="scheduleRoom" placeholder="Room Number" required />
                    <select id="scheduleFacultySelect" required>
                      <option value="">Select Faculty</option>
                    </select>
                    <button type="submit">Save Schedule</button>
                </fieldset>
            </form>
        </section>
    </main>
    <footer style="text-align:center; color:#aaa; font-size:0.95rem; margin-top:2rem; padding:1.5rem 0 0.5rem 0;">
        <div>For questions and comments, email us at <a href="mailto:prismconcerns@university.edu.ph" style="color:#e85743; text-decoration:none;">prismconcerns@university.edu.ph</a></div>
        <div style="margin-top:0.5rem;">PRISM â€“ Portal for Records, Information, and Student Management | <a href="#" style="color:#e85743; text-decoration:none;">Terms of Use</a> | <a href="#" style="color:#e85743; text-decoration:none;">Privacy Statement</a></div>
        <div style="margin-top:0.5rem; font-size:0.85rem;">Version 06.20.25A</div>
    </footer>
    <div id="editSubjectModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.18); z-index:2000; align-items:center; justify-content:center;">
      <div style="background:#fff; border-radius:12px; padding:2rem 2.5rem; min-width:320px; max-width:90vw; box-shadow:0 4px 24px rgba(0,0,0,0.15); position:relative;">
        <button onclick="closeEditModal()" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:1.5rem; color:#e85743; cursor:pointer;">&times;</button>
        <h2>Edit Subject</h2>
        <form id="editSubjectForm">
          <input type="hidden" id="editSubjectId" />
          <div>
            <label>Subject Code:</label>
            <input type="text" id="editSubjectCode" required />
          </div>
          <div>
            <label>Subject Name:</label>
            <input type="text" id="editSubjectName" required />
          </div>
          <div>
            <label>Units:</label>
            <input type="number" id="editUnits" required />
          </div>
          <div>
            <label>Room Number:</label>
            <input type="text" id="editRoomNumber" />
          </div>
          <div>
            <label>Time:</label>
            <input type="text" id="editTime" />
          </div>
          <div>
            <label>Day(s):</label>
            <input type="text" id="editDays" />
          </div>
          <button type="submit">Save Changes</button>
        </form>
      </div>
    </div>
    <script>
    var editingSectionId = null;
    document.addEventListener('DOMContentLoaded', function() {
        function showTab(sectionId) {
            document.querySelectorAll('main > section').forEach(function(sec) {
                sec.style.display = 'none';
            });
            var section = document.getElementById(sectionId);
            if (section) section.style.display = 'block';
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-tab') === sectionId);
            });
            // Refresh schedules table when Schedules tab is shown
            if (sectionId === 'schedules') {
                const selector = document.getElementById('scheduleCurriculumSelect');
                const selectedId = selector ? selector.value : '';
                fetchAndRenderSchedules(selectedId);
            }
            // Refresh All Sections table when Sections tab is shown
            if (sectionId === 'sections') {
                fetchAndRenderSections();
            }
        }
        // Show the first tab by default
        showTab('faculty');
        // Add click handlers to nav buttons
        document.querySelectorAll('.tab-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var id = btn.getAttribute('data-tab');
                showTab(id);
            });
        });
        // Populate the course dropdown for students
        fetch('/api/courses')
            .then(res => res.json())
            .then(courses => {
                const select = document.getElementById('studentCourseSelect');
                if (!select) return;
                select.innerHTML = '<option value="">None</option>';
                courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.id;
                    option.textContent = `${course.code} - ${course.name}`;
                    select.appendChild(option);
                });
            });
        // Populate the course dropdown for subjects
        fetch('/api/courses')
            .then(res => res.json())
            .then(courses => {
                const select = document.getElementById('subjectCourseSelect');
                if (!select) return;
                select.innerHTML = '<option value="">Select Course</option>';
                courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.id;
                    option.textContent = `${course.code} - ${course.name}`;
                    select.appendChild(option);
                });
            });
        // Populate schedule curriculum dropdown and do NOT auto-select the first curriculum
        fetch('/api/curriculums')
            .then(res => res.json())
            .then(curriculums => {
                const selector = document.getElementById('scheduleCurriculumSelect');
                if (!selector) return;
                selector.innerHTML = '<option value="">Select Curriculum</option>';
                curriculums.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = c.name;
                    selector.appendChild(opt);
                });
                // Do NOT auto-select the first curriculum or load subjects
                // selector.value = curriculums.length > 0 ? curriculums[0].id : '';
                // if (selector.value && selector.value !== 'undefined') {
                //     fetchAndRenderSchedules(selector.value);
                // }
                // Instead, clear the subjects table until a curriculum is selected
                const tbody = document.querySelector('#curriculumSubjectsTable tbody');
                if (tbody) tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:#888;">No subjects found.</td></tr>';
            });
        // When curriculumSelector changes, update csCurriculumId in the form
        const curriculumSelector = document.getElementById('curriculumSelector');
        if (curriculumSelector) {
            curriculumSelector.addEventListener('change', function() {
                const csCurriculumId = document.getElementById('csCurriculumId');
                if (csCurriculumId) csCurriculumId.value = this.value;
            });
        }
        // Populate section dropdown for students
        fetch('/api/sections')
            .then(res => res.json())
            .then(sections => {
                const select = document.getElementById('studentSectionSelect');
                if (!select) return;
                select.innerHTML = '<option value="">None</option>';
                sections.forEach(section => {
                    const option = document.createElement('option');
                    option.value = section.id;
                    option.textContent = section.name;
                    select.appendChild(option);
                });
            });
        populateFacultyDropdown();
        // Populate curriculum dropdown for curriculum page
        fetch('/api/curriculums')
            .then(res => res.json())
            .then(curriculums => {
                const selector = document.getElementById('curriculumPageCurriculumSelect');
                if (!selector) return;
                selector.innerHTML = '<option value="">Select Curriculum</option>';
                curriculums.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = c.name;
                    selector.appendChild(opt);
                });
                // Do NOT auto-select the first curriculum or load subjects
                // selector.value = curriculums.length > 0 ? curriculums[0].id : '';
                // if (selector.value && selector.value !== 'undefined') {
                //     fetchAndRenderSubjectsUnderCurriculum(selector.value);
                // }
                // Instead, clear the subjects table until a curriculum is selected
                const tbody = document.querySelector('#curriculumSubjectsTable tbody');
                if (tbody) tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:#888;">No subjects found.</td></tr>';
            });
        // Ensure curriculum dropdown event listener is set up correctly
        const curriculumDropdown = document.getElementById('curriculumPageCurriculumSelect');
        if (curriculumDropdown) {
            curriculumDropdown.addEventListener('change', function() {
                const curriculumId = this.value;
                if (curriculumId) {
                    fetchAndRenderSubjectsUnderCurriculum(curriculumId);
                } else {
                    // If no curriculum selected, clear the table
                    const tbody = document.querySelector('#curriculumSubjectsTable tbody');
                    if (tbody) tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:#888;">No subjects found.</td></tr>';
                }
            });
        }
        fetchAndRenderCurriculums();
        populateCSCurriculumDropdown();
        const createCurriculumForm = document.getElementById('createCurriculumForm');
        if (createCurriculumForm) {
            createCurriculumForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const name = document.getElementById('newCurriculumName').value.trim();
                if (!name) return;
                const method = editingCurriculumId ? 'PUT' : 'POST';
                const url = editingCurriculumId ? `${CURRICULUM_API_URL}/${editingCurriculumId}` : CURRICULUM_API_URL;
                fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                })
                .then(async res => {
                    if (res.ok) {
                        document.getElementById('newCurriculumName').value = '';
                        fetchAndRenderCurriculums();
                        editingCurriculumId = null;
                        document.querySelector('#saveCurriculumBtn').textContent = 'Save Curriculum';
                    } else {
                        const errorText = await res.text();
                        alert('Failed to save curriculum: ' + errorText);
                    }
                })
                .catch(err => {
                    console.error('Error creating curriculum:', err);
                    alert('Error creating curriculum: ' + err);
                });
            });
        }
        populateCSSubjectDropdown();
        const curriculumSubjectForm = document.getElementById('curriculumSubjectForm');
        if (curriculumSubjectForm) {
            curriculumSubjectForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const curriculumId = document.getElementById('csCurriculumId').value;
                const subjectId = document.getElementById('csSubjectId').value;
                const facultyId = document.getElementById('csFacultySelect').value;
                const units = document.getElementById('csUnits').value;
                const roomNumber = document.getElementById('csRoomNumber').value;
                const time = document.getElementById('csTime').value;
                const days = document.getElementById('csDays').value;

                if (!curriculumId || !subjectId) {
                    alert('Please select a curriculum and subject.');
                    return;
                }

                let url = '/api/curriculum-subjects?facultyId=' + facultyId;
                let method = 'POST';
                let body = JSON.stringify({
                    curriculum: { id: curriculumId },
                    subject: { id: subjectId },
                    units: parseInt(units),
                    roomNumber,
                    time,
                    days
                });
                if (editingCSId) {
                    url = `/api/curriculum-subjects/${editingCSId}?facultyId=${facultyId}`;
                    method = 'PUT';
                }

                fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body
                })
                .then(async res => {
                    if (res.ok) {
                        alert(editingCSId ? 'Subject updated!' : 'Subject added to curriculum!');
                        this.reset();
                        refreshCurriculumSubjects(curriculumId);
                        editingCSId = null;
                        document.querySelector('#curriculumSubjectForm button[type="submit"]').textContent = 'Save Subject to Curriculum';
                    } else {
                        const errorText = await res.text();
                        alert('Failed to save subject: ' + errorText);
                    }
                })
                .catch(err => {
                    alert('Network or server error: ' + err);
                });
            });
        }
        const sectionForm = document.getElementById('sectionForm');
        if (sectionForm) {
            sectionForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const name = document.getElementById('sectionName').value.trim();
                const saveBtn = document.querySelector('#sectionForm button[type="submit"]');
                if (!name) {
                    alert('Please enter a section name.');
                    return;
                }
                if (saveBtn) saveBtn.disabled = true;
                fetch('/api/sections', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                })
                .then(async res => {
                    if (saveBtn) saveBtn.disabled = false;
                    if (res.ok) {
                        alert('Section saved!');
                        this.reset();
                        fetchAndRenderSections();
                    } else {
                        const errorText = await res.text();
                        if (errorText && errorText.toLowerCase().includes('unique')) {
                            alert('A section with this name already exists.');
                        } else {
                            alert('Failed to save section: ' + errorText);
                        }
                    }
                })
                .catch(err => {
                    if (saveBtn) saveBtn.disabled = false;
                    alert('Network or server error: ' + err);
                });
            });
        }
        const scheduleCurriculumSelect = document.getElementById('scheduleCurriculumSelect');
        if (scheduleCurriculumSelect) {
            scheduleCurriculumSelect.addEventListener('change', function() {
                const curriculumId = String(this.value);
                console.log('[DEBUG] Dropdown changed, curriculumId:', curriculumId);
                if (curriculumId && curriculumId !== 'undefined' && curriculumId !== '') {
                    fetchAndRenderSchedules(curriculumId);
                } else {
                    fetchAndRenderSchedules();
                }
            });
            // On page load, show empty or message
            fetchAndRenderSchedules();
        }
        const sectionTableBody = document.getElementById('sectionTableBody');
        if (sectionTableBody) {
            sectionTableBody.addEventListener('click', function(e) {
                if (e.target && e.target.matches('button[data-id]')) {
                    const row = e.target.closest('tr');
                    const tds = row.querySelectorAll('td');
                    const sectionName = tds[0].textContent.trim();
                    const sectionId = e.target.getAttribute('data-id');
                    if (e.target.textContent === 'Edit') {
                        const tds = row.querySelectorAll('td');
                        const sectionName = tds[0].textContent.trim();
                        editingSectionId = sectionId;
                        document.getElementById('sectionId').value = sectionId;
                        document.getElementById('sectionName').value = sectionName;
                        document.querySelector('#sectionForm button[type="submit"]').textContent = 'Update Section';
                    }
                    if (e.target.textContent === 'Delete') {
                        if (!confirm('Are you sure you want to delete this section?')) return;
                        fetch(`/api/sections/${sectionId}`, { method: 'DELETE' })
                            .then(async res => {
                                if (res.ok) {
                                    alert('Section deleted!');
                                    fetchAndRenderSections();
                                } else {
                                    const errorText = await res.text();
                                    alert('Failed to delete section: ' + errorText);
                                }
                            })
                            .catch(err => {
                                alert('Network or server error: ' + err);
                            });
                    }
                }
            });
        }
        // Event delegation for Schedule Management table
        const schedulesTableBody = document.getElementById('schedulesTableBody');
        if (schedulesTableBody) {
            schedulesTableBody.addEventListener('click', function(e) {
                if (e.target && e.target.matches('button.schedule-edit-btn')) {
                    const row = e.target.closest('tr');
                    const tds = row.querySelectorAll('td');
                    // Populate the Add/Edit Schedule form with row data
                    document.getElementById('scheduleCourseCode').value = tds[0].textContent.trim();
                    document.getElementById('scheduleCourseName').value = tds[1].textContent.trim();
                    document.getElementById('scheduleDay').value = tds[2].textContent.trim();
                    document.getElementById('scheduleTime').value = tds[3].textContent.trim();
                    document.getElementById('scheduleRoom').value = tds[4].textContent.trim();
                    // Faculty select by facultyId, using robust dropdown population
                    const facultyId = e.target.getAttribute('data-faculty-id');
                    populateScheduleFacultyDropdown(facultyId);
                    // Store subject id for update
                    document.getElementById('scheduleSubjectId').value = e.target.getAttribute('data-id');
                    // Store schedule id for update
                    document.getElementById('scheduleId').value = e.target.getAttribute('data-schedule-id');
                    document.querySelector('#scheduleForm button[type="submit"]').textContent = 'Update Schedule';
                }
                if (e.target && e.target.matches('button.schedule-delete-btn')) {
                    if (!confirm('Are you sure you want to delete this schedule?')) return;
                    const subjectId = e.target.getAttribute('data-id');
                    const curriculumId = document.getElementById('scheduleCurriculumSelect').value;
                    fetch(`/api/schedules/curriculum/${curriculumId}/subject/${subjectId}`, { method: 'DELETE' })
                        .then(async res => {
                            if (res.ok) {
                                alert('Schedule deleted!');
                                fetchAndRenderSchedules(curriculumId);
                            } else {
                                const errorText = await res.text();
                                alert('Failed to delete schedule: ' + errorText);
                            }
                        })
                        .catch(err => {
                            alert('Network or server error: ' + err);
                        });
                }
            });
        }
        const scheduleForm = document.getElementById('scheduleForm');
        if (scheduleForm) {
            scheduleForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const scheduleId = document.getElementById('scheduleId').value;
                const curriculumId = document.getElementById('scheduleCurriculumSelect').value;
                const subjectId = document.getElementById('scheduleSubjectId').value;
                const courseCode = document.getElementById('scheduleCourseCode').value;
                const courseName = document.getElementById('scheduleCourseName').value;
                const day = document.getElementById('scheduleDay').value;
                const time = document.getElementById('scheduleTime').value;
                const room = document.getElementById('scheduleRoom').value;
                const facultyId = document.getElementById('scheduleFacultySelect').value;

                const payload = {
                    curriculumId,
                    subjectId,
                    courseCode,
                    courseName,
                    day,
                    time,
                    room,
                    facultyId
                };

                let url, method;
                if (scheduleId) {
                    url = `/api/schedules/${scheduleId}`;
                    method = 'PUT';
                } else {
                    url = '/api/schedules';
                    method = 'POST';
                }

                fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                .then(async res => {
                    if (res.ok) {
                        alert(scheduleId ? 'Schedule updated!' : 'Schedule created!');
                        fetchAndRenderSchedules(curriculumId);
                        this.reset();
                        document.querySelector('#scheduleForm button[type="submit"]').textContent = 'Save Schedule';
                    } else {
                        const errorText = await res.text();
                        alert('Failed to save schedule: ' + errorText);
                    }
                })
                .catch(err => {
                    alert('Network or server error: ' + err);
                });
            });
        }
        // Add event delegation for Edit and Delete buttons in Subjects Under Selected Curriculum table
        const curriculumSubjectsTableBody = document.querySelector('#curriculumSubjectsTable tbody');
        if (curriculumSubjectsTableBody) {
            curriculumSubjectsTableBody.addEventListener('click', function(e) {
                if (e.target && e.target.classList.contains('schedule-edit-btn')) {
                    const subjectId = e.target.getAttribute('data-id');
                    // Find the subject object by ID
                    const cs = (window.lastCurriculumSubjectsList || []).find(s => String(s.id) === String(subjectId));
                    if (cs) {
                        window.editCurriculumSubject(cs);
                    }
                }
                if (e.target && e.target.classList.contains('schedule-delete-btn')) {
                    const subjectId = e.target.getAttribute('data-id');
                    deleteCurriculumSubject(subjectId);
                }
            });
        }
    });
    // --- Faculty Add/Render Logic ---
    const FACULTY_API_URL = '/api/faculty';
    const FACULTY_ADMIN_API_URL = '/api/admins/faculty';
    let editingFacultyId = null;

    function fetchAndRenderFaculty() {
        fetch(FACULTY_API_URL)
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('facultyTableBody');
                tbody.innerHTML = '';
                data.forEach(faculty => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${faculty.id ?? ''}</td>
                        <td>${faculty.fullName ?? ''}</td>
                        <td>${faculty.email ?? ''}</td>
                        <td>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <button type="button" style="margin-right:8px;" onclick="editFaculty(${faculty.id}, '${faculty.fullName?.replace(/'/g, "&#39;")}', '${faculty.email?.replace(/'/g, "&#39;")}')">Edit</button>
                                <button type="button" onclick="deleteFaculty(${faculty.id})">Delete</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            });
    }

    window.editFaculty = function(id, fullName, email) {
        editingFacultyId = id;
        document.getElementById('facultyName').value = fullName;
        document.getElementById('facultyEmail').value = email;
        document.getElementById('facultyPassword').value = '';
        document.querySelector('#facultyForm button[type="submit"]').textContent = 'Update Faculty Account';
    };

    window.deleteFaculty = function(id) {
        if (!confirm('Are you sure you want to delete this faculty member?')) return;
        fetch(`${FACULTY_ADMIN_API_URL}/${id}`, { method: 'DELETE' })
            .then(res => {
                if (res.ok) fetchAndRenderFaculty();
                else alert('Failed to delete faculty');
            });
    };

    document.getElementById('facultyForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const fullName = document.getElementById('facultyName').value;
        const email = document.getElementById('facultyEmail').value;
        const password = document.getElementById('facultyPassword').value;
        const method = editingFacultyId ? 'PUT' : 'POST';
        const url = editingFacultyId ? `${FACULTY_ADMIN_API_URL}/${editingFacultyId}` : FACULTY_API_URL;
        fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ fullName, email, password })
        })
        .then(res => {
            if (res.ok) {
                fetchAndRenderFaculty();
                this.reset();
                editingFacultyId = null;
                document.querySelector('#facultyForm button[type="submit"]').textContent = 'Create Faculty Account';
            } else {
                alert('Failed to save faculty');
            }
        });
    });

    // Fetch faculty list on page load
    fetchAndRenderFaculty();

    // --- Student Add/Edit/Delete/Render Logic ---
    const STUDENT_API_URL = '/api/admin/student'; // for all actions
    let editingStudentId = null;

    function fetchAndRenderStudents() {
        fetch(STUDENT_API_URL)
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('studentTableBody');
                tbody.innerHTML = '';
                data.forEach(student => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${student.id ?? ''}</td>
                        <td>${student.studentNumber ?? ''}</td>
                        <td>${student.name ?? ''}</td>
                        <td>${student.email ?? ''}</td>
                        <td>${student.course ? (student.course.code + ' - ' + student.course.name) : ''}</td>
                        <td>${student.section ? student.section.name : ''}</td>
                        <td>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <button type="button" style="margin-right:8px;" onclick="editStudent(${student.id}, '${student.studentNumber?.replace(/'/g, "&#39;")}', '${student.name?.replace(/'/g, "&#39;")}', '${student.email?.replace(/'/g, "&#39;")}', ${student.course?.id ?? 'null'})">Edit</button>
                                <button type="button" onclick="deleteStudent(${student.id})">Delete</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            });
    }

    window.editStudent = function(id, studentNumber, name, email, courseId) {
        editingStudentId = id;
        document.getElementById('studentId').value = id;
        document.getElementById('studentNumber').value = studentNumber;
        document.getElementById('name').value = name;
        document.getElementById('email').value = email;
        document.getElementById('password').value = '';
        document.querySelector('#studentForm button[type="submit"]').textContent = 'Update Student';
        // Set the course dropdown to the correct value
        const courseSelect = document.getElementById('studentCourseSelect');
        if (courseSelect) courseSelect.value = courseId || '';
    };

    window.deleteStudent = function(id) {
        if (!confirm('Are you sure you want to delete this student?')) return;
        fetch(`${STUDENT_API_URL}/${id}`, { method: 'DELETE' })
            .then(async res => {
                if (res.ok) fetchAndRenderStudents();
                else {
                    const errorText = await res.text();
                    alert('Failed to delete student: ' + errorText);
                }
            });
    };

    document.getElementById('studentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const studentNumber = document.getElementById('studentNumber').value;
        const name = document.getElementById('name').value;
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const courseId = document.getElementById('studentCourseSelect').value;
        const sectionId = document.getElementById('studentSectionSelect').value;
        if (!courseId) {
            alert('Please select a Course for the student.');
            return;
        }
        if (!sectionId) {
            alert('Please select a Section for the student.');
            return;
        }
        const method = editingStudentId ? 'PUT' : 'POST';
        const url = editingStudentId ? `${STUDENT_API_URL}/${editingStudentId}` : STUDENT_API_URL;
        const studentData = {
            studentNumber,
            name,
            email,
            password,
            courseId: courseId || null,
            sectionId: sectionId || null
        };
        // Log request details
        if (method === 'PUT') {
            console.log('PUT request to:', url);
            console.log('Request body:', studentData);
        }
        fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(studentData)
        })
        .then(async res => {
            // Log response details
            if (method === 'PUT') {
                console.log('Response status:', res.status);
                let respText = await res.clone().text();
                try { respText = JSON.parse(respText); } catch (e) {}
                console.log('Response body:', respText);
            }
            if (res.ok) {
                fetchAndRenderStudents();
                this.reset();
                editingStudentId = null;
                document.querySelector('#studentForm button[type="submit"]').textContent = 'Save Student';
            } else {
                alert('Failed to save student');
            }
        });
    });

    // Fetch students on page load
    fetchAndRenderStudents();

    // --- Course Add/Edit/Delete/Render Logic ---
    const COURSE_API_URL = '/api/courses'; // for all actions
    let editingCourseId = null;

    function fetchAndRenderCourses() {
        fetch(COURSE_API_URL)
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('courseTableBody');
                if (!tbody) return;
                tbody.innerHTML = '';
                data.forEach(course => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${course.code ?? ''}</td>
                        <td>${course.name ?? ''}</td>
                        <td>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <button type="button" style="margin-right:8px;" onclick="editCourse(${course.id}, '${course.code?.replace(/'/g, "&#39;")}', '${course.name?.replace(/'/g, "&#39;")}')">Edit</button>
                                <button type="button" onclick="deleteCourse(${course.id})">Delete</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            });
    }

    window.editCourse = function(id, code, name) {
        editingCourseId = id;
        document.getElementById('courseId').value = id;
        document.getElementById('courseCode').value = code;
        document.getElementById('courseName').value = name;
        document.querySelector('#courseForm button[type="submit"]').textContent = 'Update Course';
    };

    window.deleteCourse = async function(id) {
        // Fetch dependencies
        const [students, curriculums, enrollments] = await Promise.all([
            fetch(`/api/courses/${id}/students`).then(r => r.json()),
            fetch(`/api/courses/${id}/curriculums`).then(r => r.json()),
            fetch(`/api/courses/${id}/enrollments`).then(r => r.json())
        ]);
        let message = '';
        if (students.length > 0) {
            message += `Students assigned to this course:\n` + students.map(s => `- ${s.name || s.studentNumber || s.id}`).join('\n') + '\n';
        }
        if (curriculums.length > 0) {
            message += `Curriculums using this course:\n` + curriculums.map(c => `- ${c.name || c.id}`).join('\n') + '\n';
        }
        if (enrollments.length > 0) {
            message += `Enrollments using this course:\n` + enrollments.map(e => `- Enrollment ID: ${e.id}`).join('\n') + '\n';
        }
        if (message) {
            alert('Cannot delete course. It is still referenced by:\n\n' + message + '\nPlease unassign or remove these dependencies first.');
            return;
        }
        if (!confirm('Are you sure you want to delete this course?')) return;
        fetch(`${COURSE_API_URL}/${id}`, { method: 'DELETE' })
            .then(async res => {
                if (res.ok) fetchAndRenderCourses();
                else {
                    const errorText = await res.text();
                    alert('Failed to delete course: ' + errorText);
                }
            });
    };

    document.getElementById('courseForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const code = document.getElementById('courseCode').value;
        const name = document.getElementById('courseName').value;
        const method = editingCourseId ? 'PUT' : 'POST';
        const url = editingCourseId ? `${COURSE_API_URL}/${editingCourseId}` : COURSE_API_URL;
        const body = { code, name };
        fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        })
        .then(async res => {
            if (res.ok) {
                fetchAndRenderCourses();
                this.reset();
                editingCourseId = null;
                document.querySelector('#courseForm button[type="submit"]').textContent = 'Save Course';
            } else {
                const errorText = await res.text();
                alert('Failed to save course: ' + errorText);
            }
        });
    });

    // Fetch courses on page load
    fetchAndRenderCourses();

    // --- Subject Add/Edit/Delete/Render Logic ---
    const SUBJECT_API_URL = '/api/subjects'; // for all actions
    let editingSubjectId = null;

    function fetchAndRenderSubjects() {
        fetch(SUBJECT_API_URL)
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('subjectTableBody');
                if (!tbody) return;
                tbody.innerHTML = '';
                data.forEach(subject => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${subject.subjectCode ?? ''}</td>
                        <td>${subject.subjectName ?? ''}</td>
                        <td>${subject.course ? (subject.course.code + ' - ' + subject.course.name) : ''}</td>
                        <td>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <button type="button" style="margin-right:8px;" onclick="editSubject(${subject.id}, '${subject.subjectCode?.replace(/'/g, "&#39;")}', '${subject.subjectName?.replace(/'/g, "&#39;")}', ${subject.course?.id ?? 'null'})">Edit</button>
                                <button type="button" onclick="deleteSubject(${subject.id})">Delete</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            });
    }

    window.editSubject = function(id, subjectCode, subjectName, courseId) {
        editingSubjectId = id;
        document.getElementById('subjectId').value = id;
        document.getElementById('subjectCode').value = subjectCode;
        document.getElementById('subjectName').value = subjectName;
        document.getElementById('subjectCourseSelect').value = courseId || '';
        document.querySelector('#subjectForm button[type="submit"]').textContent = 'Update Subject';
    };

    window.deleteSubject = function(id) {
        if (!confirm('Are you sure you want to delete this subject?')) return;
        fetch(`${SUBJECT_API_URL}/${id}`, { method: 'DELETE' })
            .then(async res => {
                if (res.ok) fetchAndRenderSubjects();
                else {
                    const errorText = await res.text();
                    alert('Failed to delete subject: ' + errorText);
                }
            });
    };

    document.getElementById('subjectForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const courseId = document.getElementById('subjectCourseSelect').value;
        const subjectCode = document.getElementById('subjectCode').value;
        const subjectName = document.getElementById('subjectName').value;
        const method = editingSubjectId ? 'PUT' : 'POST';
        const url = editingSubjectId ? `/api/subjects/${editingSubjectId}` : '/api/subjects';
        const body = { subjectCode, subjectName, courseId };

        fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        })
        .then(res => {
            if (res.ok) {
                fetchAndRenderSubjects();
                this.reset();
                editingSubjectId = null;
                document.querySelector('#subjectForm button[type="submit"]').textContent = 'Save Subject';
            } else {
                alert('Failed to save subject');
            }
        });
    });

    // Fetch subjects on page load
    fetchAndRenderSubjects();

    // --- Curriculum Add/Edit/Delete/Render Logic ---
    const CURRICULUM_API_URL = '/api/curriculums'; // for all actions
    let editingCurriculumId = null;

    function fetchAndRenderCurriculums() {
        fetch(CURRICULUM_API_URL)
            .then(res => res.json())
            .then(curriculums => {
                const tbody = document.getElementById('curriculumTableBody');
                if (!tbody) return;
                tbody.innerHTML = '';
                curriculums.forEach(c => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${c.name}</td>
                        <td>
                            <button onclick="editCurriculum(${c.id}, '${c.name.replace(/'/g, "&#39;")}')">Edit</button>
                            <button onclick="deleteCurriculum(${c.id})">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            });
    }

    window.editCurriculum = function(id, name) {
        editingCurriculumId = id;
        document.getElementById('newCurriculumName').value = name;
        document.querySelector('#saveCurriculumBtn').textContent = 'Update Curriculum';
    };

    window.deleteCurriculum = function(id) {
        if (!confirm('Are you sure you want to delete this curriculum?')) return;
        fetch(`${CURRICULUM_API_URL}/${id}`, { method: 'DELETE' })
            .then(async res => {
                if (res.ok) fetchAndRenderCurriculums();
                else {
                    const errorText = await res.text();
                    alert('Failed to delete curriculum: ' + errorText);
                }
            });
    };

    var curriculumForm = document.getElementById('curriculumForm');
    if (curriculumForm) {
        curriculumForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('curriculumName').value;
            const method = editingCurriculumId ? 'PUT' : 'POST';
            const url = editingCurriculumId ? `${CURRICULUM_API_URL}/${editingCurriculumId}` : CURRICULUM_API_URL;
            const body = { name };
            fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            })
            .then(async res => {
                if (res.ok) {
                    document.getElementById('newCurriculumName').value = '';
                    fetchAndRenderCurriculums();
                    editingCurriculumId = null;
                    document.querySelector('#saveCurriculumBtn').textContent = 'Save Curriculum';
                } else {
                    const errorText = await res.text();
                    alert('Failed to save curriculum: ' + errorText);
                }
            })
            .catch(err => {
                console.error('Error creating curriculum:', err);
                alert('Error creating curriculum: ' + err);
            });
        });
    }

    // Fetch curriculums on page load
    fetchAndRenderCurriculums();

    // --- Subjects Under Curriculum Functionality ---
    function fetchAndRenderSubjectsUnderCurriculum(curriculumId) {
        fetch(`/api/curriculums/${curriculumId}/subjects`)
            .then(res => res.json())
            .then(subjects => {
                window.lastCurriculumSubjectsList = subjects; // Store globally for edit lookup
                const tbody = document.querySelector('#curriculumSubjectsTable tbody');
                tbody.innerHTML = '';
                if (!subjects || !subjects.length) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:#888;">No subjects found.</td></tr>';
                    return;
                }
                subjects.forEach(subject => {
                    const tr = document.createElement('tr');
                    tr.setAttribute('data-cs-id', subject.id); // Store id for lookup
                    tr.innerHTML = `
                        <td>${subject.subjectCode || ''}</td>
                        <td>${subject.subjectName || ''}</td>
                        <td>${subject.units != null ? subject.units : ''}</td>
                        <td>${subject.roomNumber || ''}</td>
                        <td>${subject.time || ''}</td>
                        <td>${subject.days || ''}</td>
                        <td>${subject.facultyName || ''}</td>
                        <td>
                            <button type="button" class="schedule-edit-btn" data-id="${subject.id}">Edit</button>
                            <button type="button" class="schedule-delete-btn" data-id="${subject.id}">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            })
            .catch(err => {
                console.error('Failed to load subjects:', err);
                const tbody = document.querySelector('#curriculumSubjectsTable tbody');
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:#e85743;">Failed to load subjects.</td></tr>';
            });
    }

    // Add click event to curriculum rows after rendering curriculums
    function addCurriculumRowClickHandlers() {
        const rows = document.querySelectorAll('#curriculumTableBody tr');
        rows.forEach(row => {
            row.onclick = function() {
                rows.forEach(r => r.style.background = '');
                this.style.background = '#ffeaea';
                const curriculumId = this.querySelector('td').textContent;
                fetchAndRenderSubjectsUnderCurriculum(curriculumId);
            };
        });
    }

    // Patch fetchAndRenderCurriculums to add click handlers after rendering
    const origFetchAndRenderCurriculums = fetchAndRenderCurriculums;
    fetchAndRenderCurriculums = function() {
        origFetchAndRenderCurriculums();
        setTimeout(() => {
            addCurriculumRowClickHandlers();
            // Auto-select and load the first curriculum's subjects if available
            const firstRow = document.querySelector('#curriculumTableBody tr');
            if (firstRow) {
                firstRow.click();
            } else {
                // If no curriculums, clear the subjects table
                const tbody = document.querySelector('#curriculumSubjectsTable tbody');
                if (tbody) tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:#888;">No subjects found.</td></tr>';
            }
        }, 100);
    };

    // --- CurriculumSubject Add/Edit/Delete/Render Logic ---
    const CURRICULUM_SUBJECT_API_URL = '/api/curriculum-subjects';
    let editingCSId = null;
    let selectedCurriculumId = null;

    // Populate curriculum dropdown
    function populateCSCurriculumDropdown(selectedId) {
        fetch('/api/curriculums')
            .then(res => res.json())
            .then(data => {
                const select = document.getElementById('csCurriculumId');
                if (!select) return;
                select.innerHTML = '<option value="">Select Curriculum</option>';
                data.forEach(curriculum => {
                    const option = document.createElement('option');
                    option.value = curriculum.id;
                    option.textContent = curriculum.name;
                    if (selectedId && String(curriculum.id) === String(selectedId)) option.selected = true;
                    select.appendChild(option);
                });
            });
    }

    // Populate subject dropdown
    function populateCSSubjectDropdown(selectedId) {
        fetch('/api/subjects')
            .then(res => res.json())
            .then(data => {
                const select = document.getElementById('csSubjectId');
                if (!select) return;
                select.innerHTML = '<option value="">Select Subject</option>';
                data.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.id;
                    option.textContent = `${subject.subjectCode} - ${subject.subjectName}`;
                    if (selectedId && String(subject.id) === String(selectedId)) option.selected = true;
                    select.appendChild(option);
                });
            });
    }
    populateCSSubjectDropdown();
    populateCSCurriculumDropdown(selectedCurriculumId);

    // Edit CurriculumSubject (new version: takes subject object)
    window.editCurriculumSubject = function(cs) {
        if (!cs) return;
        editingCSId = cs.id;
        populateFacultyDropdown();
        document.getElementById('csCurriculumId').value = cs.curriculumId || cs.curriculum?.id || '';
        document.getElementById('csSubjectId').value = cs.subjectId || cs.subject?.id || '';
        document.getElementById('csUnits').value = cs.units;
        document.getElementById('csRoomNumber').value = cs.roomNumber || '';
        document.getElementById('csTime').value = cs.time || '';
        document.getElementById('csDays').value = cs.days || '';
        document.querySelector('#curriculumSubjectForm button[type="submit"]').textContent = 'Update Subject in Curriculum';
        if (cs.facultyName) {
            const facultySelect = document.getElementById('csFacultySelect');
            if (facultySelect) {
                for (let i = 0; i < facultySelect.options.length; i++) {
                    if (facultySelect.options[i].text === cs.facultyName) {
                        facultySelect.selectedIndex = i;
                        break;
                    }
                }
            }
        } else {
            const facultySelect = document.getElementById('csFacultySelect');
            if (facultySelect) facultySelect.selectedIndex = 0;
        }
    };

    // Delete CurriculumSubject
    window.deleteCurriculumSubject = function(csId) {
        if (!confirm('Are you sure you want to delete this subject from the curriculum?')) return;
        fetch(`${CURRICULUM_SUBJECT_API_URL}/${csId}`, { method: 'DELETE' })
            .then(async res => {
                if (res.ok) {
                    const selectedCurriculumId = document.getElementById('curriculumPageCurriculumSelect').value;
                    if (selectedCurriculumId) {
                        fetchAndRenderSubjectsUnderCurriculum(selectedCurriculumId);
                    }
                    this.reset();
                    editingCSId = null;
                    document.querySelector('#curriculumSubjectForm button[type="submit"]').textContent = 'Save Subject to Curriculum';
                } else {
                    const errorText = await res.text();
                    alert('Failed to delete subject from curriculum: ' + errorText);
                }
            });
    };

    // Add this function to reload and highlight the curriculum subjects table
    function refreshCurriculumSubjects(curriculumId, highlightSubjectId = null) {
        console.log('Refreshing curriculum subjects for curriculumId:', curriculumId);
        fetch(`/api/curriculums/${curriculumId}/subjects`)
            .then(res => res.json())
            .then(subjects => {
                console.log('Subjects API response:', subjects);
                window.lastCurriculumSubjectsList = subjects; // Store globally for edit lookup
                const tbody = document.querySelector('#curriculumSubjectsTable tbody');
                tbody.innerHTML = '';
                if (!subjects || !subjects.length) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:#888;">No subjects found.</td></tr>';
                    return;
                }
                subjects.forEach(subject => {
                    const tr = document.createElement('tr');
                    tr.setAttribute('data-cs-id', subject.id); // Store id for lookup
                    tr.innerHTML = `
                        <td>${subject.subjectCode || ''}</td>
                        <td>${subject.subjectName || ''}</td>
                        <td>${subject.units != null ? subject.units : ''}</td>
                        <td>${subject.roomNumber || ''}</td>
                        <td>${subject.time || ''}</td>
                        <td>${subject.days || ''}</td>
                        <td>${subject.facultyName || ''}</td>
                        <td>
                            <button type="button" class="schedule-edit-btn" data-id="${subject.id}">Edit</button>
                            <button type="button" class="schedule-delete-btn" data-id="${subject.id}">Delete</button>
                        </td>
                    `;
                    if (highlightSubjectId && (subject.id === highlightSubjectId || subject.subjectId === highlightSubjectId)) {
                        tr.style.background = '#fff7d6'; // highlight color
                    }
                    tbody.appendChild(tr);
                });
            })
            .catch(err => {
                alert('Failed to load subjects: ' + err);
            });
    }

    // Populate faculty dropdown
    function populateFacultyDropdown(selectedId) {
        console.log('Populating faculty dropdown...');
        fetch('/api/faculty')
            .then(res => res.json())
            .then(data => {
                console.log('Faculty data:', data);
                const select = document.getElementById('csFacultySelect');
                if (!select) {
                    console.log('csFacultySelect element not found!');
                    return;
                }
                select.innerHTML = '<option value="">Select Faculty</option>';
                data.forEach(faculty => {
                    const option = document.createElement('option');
                    option.value = faculty.id;
                    option.textContent = faculty.fullName;
                    if (selectedId && String(faculty.id) === String(selectedId)) option.selected = true;
                    select.appendChild(option);
                });
            });
    }

    function populateScheduleFacultyDropdown(selectedId) {
        fetch('/api/faculty')
            .then(res => res.json())
            .then(data => {
                console.log('Schedule Faculty data:', data); // Debug log
                const select = document.getElementById('scheduleFacultySelect');
                if (!select) {
                    console.log('scheduleFacultySelect element not found!');
                    return;
                }
                select.innerHTML = '<option value="">Select Faculty</option>';
                data.forEach(faculty => {
                    const option = document.createElement('option');
                    option.value = faculty.id;
                    option.textContent = faculty.fullName;
                    select.appendChild(option);
                });
                // Set the value after options are populated
                if (selectedId) {
                    select.value = selectedId;
                }
            });
    }

    function openEditModal(subject) {
        document.getElementById('editSubjectId').value = subject.id;
        document.getElementById('editSubjectCode').value = subject.subjectCode || (subject.subject && subject.subject.subjectCode) || '';
        document.getElementById('editSubjectName').value = subject.subjectName || (subject.subject && subject.subject.subjectName) || '';
        document.getElementById('editUnits').value = subject.units || '';
        document.getElementById('editRoomNumber').value = subject.roomNumber || '';
        document.getElementById('editTime').value = subject.time || '';
        document.getElementById('editDays').value = subject.days || '';
        document.getElementById('editSubjectModal').style.display = 'flex';
    }

    function closeEditModal() {
        document.getElementById('editSubjectModal').style.display = 'none';
    }

    document.getElementById('editSubjectForm').onsubmit = async function(e) {
        e.preventDefault();
        const id = document.getElementById('editSubjectId').value;
        const data = {
            subjectCode: document.getElementById('editSubjectCode').value,
            subjectName: document.getElementById('editSubjectName').value,
            units: document.getElementById('editUnits').value,
            roomNumber: document.getElementById('editRoomNumber').value,
            time: document.getElementById('editTime').value,
            days: document.getElementById('editDays').value,
        };
        const response = await fetch(`/api/subjects/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        if (response.ok) {
            alert('Subject updated successfully!');
            closeEditModal();
            refreshCurriculumSubjects(selectedCurriculumId);
        } else {
            alert('Failed to update subject.');
        }
    };

    function fetchAndRenderSections() {
        fetch('/api/sections')
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('sectionTableBody');
                tbody.innerHTML = '';
                data.forEach(section => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${section.name ?? ''}</td>
                        <td>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <button type="button" data-id="${section.id}" style="margin-right:8px;">Edit</button>
                                <button type="button" data-id="${section.id}">Delete</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            });
    }

    function fetchAndRenderSchedules(curriculumId) {
        const tbody = document.getElementById('schedulesTableBody');
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:#888;">Loading...</td></tr>';

        if (!curriculumId) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:#888;">Please select a curriculum.</td></tr>';
            return;
        }

        console.log('[DEBUG] fetchAndRenderSchedules called with curriculumId:', curriculumId);
        Promise.all([
            fetch(`/api/curriculums/${curriculumId}/subjects`).then(res => res.json()),
            fetch(`/api/schedules/curriculum/${curriculumId}`).then(res => res.json())
        ]).then(([subjects, schedules]) => {
            console.log('[DEBUG] Subjects API response for curriculumId', curriculumId, ':', subjects);
            tbody.innerHTML = '';
            if (!subjects.length) {
                tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; color:#e85743;">No subjects found for this curriculum (ID: ${curriculumId}).<br>Check if subjects are assigned to this curriculum and not soft-deleted.</td></tr>`;
                return;
            }
            subjects.forEach(subject => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${subject.subjectCode || ''}</td>
                    <td>${subject.subjectName || ''}</td>
                    <td>${subject.units != null ? subject.units : ''}</td>
                    <td>${subject.roomNumber || ''}</td>
                    <td>${subject.time || ''}</td>
                    <td>${subject.days || ''}</td>
                    <td>${subject.facultyName || ''}</td>
                    <td>
                        <div class="action-buttons">
                            <button type="button" class="schedule-edit-btn" data-id="${subject.id}">Edit</button>
                            <button type="button" class="schedule-delete-btn" data-id="${subject.id}">Delete</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }).catch((err) => {
            tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; color:#e85743;">Failed to load schedule. Error: ${err}</td></tr>`;
        });
    }

    // Add custom validation for Student Number format (SIS-0000)
    const studentNumberInput = document.getElementById('studentNumber');
    if (studentNumberInput) {
      studentNumberInput.addEventListener('input', function() {
        const pattern = /^SIS-\d{4}$/;
        if (!pattern.test(this.value)) {
          this.setCustomValidity('Student Number must be in the format SIS-0000');
        } else {
          this.setCustomValidity('');
        }
      });
    }
    </script>
</body>

</html>