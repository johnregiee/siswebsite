<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Student Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #f0f0f0;
        }

        nav {
            background-color: #005792;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        nav .brand {
            font-size: 1.2em;
            font-weight: bold;
        }

        nav .nav-links span {
            cursor: pointer;
            color: white;
            padding: 5px 10px;
        }

        .container {
            padding: 20px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        table,
        th,
        td {
            border: 1px solid #ccc;
        }

        th,
        td {
            padding: 10px;
            text-align: left;
        }

        th {
            background-color: #e0e0e0;
        }
    </style>
</head>

<body>

    <nav>
        <div class="brand">Student Dashboard</div>
        <div class="nav-links">
            <span data-target="homeSection">Home</span>
            <span data-target="enrollmentSection">Enrollment</span>
            <span data-target="accountsSection">Accounts</span>
            <span data-target="scheduleSection">Schedule</span>
            <span data-target="gradesSection">Grades</span>
        </div>
    </nav>

    <div class="container">
        <!-- HOME SECTION (Default) -->
        <div id="homeSection" class="section active">
            <h2>Welcome to your Dashboard, <span id="student-name-placeholder">Student</span>!</h2>
            <p>Select a section from the navigation bar to view your information.</p>
        </div>

        <!-- ENROLLMENT SECTION -->
        <div id="enrollmentSection" class="section">
            <h2>Enrollment</h2>
            <label for="subjectSelect">Select Course to Enroll:</label>
            <select id="subjectSelect"></select>
            <button id="enrollBtn">Enroll</button>
            <hr>
            <h3>My Enrolled Subjects</h3>
            <ul id="enrolledSubjects"></ul>
        </div>

        <!-- ACCOUNTS SECTION -->
        <div id="accountsSection" class="section">
            <h2>Accounts</h2>
            <p>Your financial statement and balance.</p>
            <table>
                <thead>
                    <tr>
                        <th>Semester</th>
                        <th>Tuition Fee</th>
                        <th>Amount Paid</th>
                        <th>Balance</th>
                    </tr>
                </thead>
                <tbody id="accountsTableBody"></tbody>
            </table>
        </div>

        <!-- SCHEDULE SECTION -->
        <!-- All schedule-related HTML is now properly contained here -->
        <div id="scheduleSection" class="section">
            <h2>My Class Schedule</h2>
            <p>Here is your schedule for the current semester.</p>
            <table id="scheduleTable">
                <thead>
                    <tr>
                        <th>Course Code</th>
                        <th>Course Name</th>
                        <th>Day(s)</th>
                        <th>Time</th>
                        <th>Room</th>
                    </tr>
                </thead>
                <tbody id="scheduleTableBody">
                    <!-- Schedule rows will be inserted here by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- GRADES SECTION -->

        <div id="gradesSection" class="section">
            <h2>My Grades</h2>
            <p>Your academic performance will be shown here once available.</p>
            <table id="gradesTable">
                <thead>
                    <tr>
                        <th>Semester</th>
                        <th>Course Code</th>
                        <th>Course Name</th>
                        <th>Grade</th>
                        <th>Comments</th>
                    </tr>
                </thead>
                <tbody id="gradesTableBody">
                    <!-- Grade rows will be inserted here by JavaScript -->
                </tbody>
            </table>
        </div>

        <script>
            // --- SINGLE SOURCE OF TRUTH FOR STUDENT ID ---
            const studentId = sessionStorage.getItem("studentId");

            // Redirect if not logged in
            if (!studentId) {
                alert("You are not logged in. Redirecting to login page...");
                window.location.href = "login.html";
            }

            // --- COMBINED AND CLEANED-UP SCRIPT ---
            $(document).ready(function () {

                // --- ALL API-LOADING FUNCTIONS ---

                // Function to load student's schedule
                async function loadStudentSchedule() {
                    const tableBody = $('#scheduleTableBody');
                    tableBody.html('<tr><td colspan="5">Loading...</td></tr>'); // Show loading feedback
                    try {
                        const response = await fetch(`http://localhost:8080/api/schedules/student/${studentId}`);
                        if (!response.ok) throw new Error('Failed to fetch schedule from server.');

                        const schedules = await response.json();
                        tableBody.empty(); // Clear the loading message

                        if (schedules.length === 0) {
                            tableBody.html('<tr><td colspan="5">You have no schedules assigned yet.</td></tr>');
                        } else {
                            schedules.forEach(schedule => {
                                const row = `
                                <tr>
                                    <td>${schedule.courseCode}</td>
                                    <td>${schedule.courseName}</td>
                                    <td>${schedule.day}</td>
                                    <td>${schedule.time}</td>
                                    <td>${schedule.room}</td>
                                </tr>`;
                                tableBody.append(row);
                            });
                        }
                    } catch (error) {
                        console.error('Error loading schedule:', error);
                        tableBody.html('<tr><td colspan="5" style="color: red;">Could not load schedule. Please try again later.</td></tr>');
                    }
                }

                async function loadStudentAccounts() {
                    const tableBody = $('#accountsTableBody');
                    tableBody.html('<tr><td colspan="4">Loading...</td></tr>');
                    try {
                        const response = await fetch(`http://localhost:8080/api/accounts/student/${studentId}`);
                        if (!response.ok) throw new Error('Failed to fetch accounts');

                        const data = await response.json();
                        tableBody.empty();

                        if (data.length === 0) {
                            tableBody.html('<tr><td colspan="4">No account information available.</td></tr>');
                        } else {
                            data.forEach(account => {
                                const row = `
                                <tr>
                                    <td>${account.semester}</td>
                                    <td>₱${account.tuitionFee.toFixed(2)}</td>
                                    <td>₱${account.amountPaid.toFixed(2)}</td>
                                    <td>₱${account.balance.toFixed(2)}</td>
                                </tr>`;
                                tableBody.append(row);
                            });
                        }
                    } catch (error) {
                        console.error('Error loading accounts:', error);
                        tableBody.html('<tr><td colspan="4" style="color: red;">Could not load accounts.</td></tr>');
                    }
                }

                async function loadStudentGrades() {
                    const tableBody = $('#gradesTableBody');
                    tableBody.html('<tr><td colspan="5">Loading grades...</td></tr>'); // Show loading feedback

                    try {
                        const response = await fetch(`http://localhost:8080/api/grades/student/${studentId}`);
                        if (!response.ok) throw new Error('Failed to fetch grades from server.');

                        const grades = await response.json();
                        tableBody.empty(); // Clear the loading message

                        if (grades.length === 0) {
                            tableBody.html('<tr><td colspan="5">No grades are available yet.</td></tr>');
                        } else {
                            grades.forEach(grade => {
                                const row = `
                    <tr>
                        <td>${grade.semester}</td>
                        <td>${grade.courseCode}</td>
                        <td>${grade.courseName}</td>
                        <td><strong>${grade.grade}</strong></td>
                        <td>${grade.comments || ''}</td>
                    </tr>`; // Use '|| ""' for empty comments
                                tableBody.append(row);
                            });
                        }
                    } catch (error) {
                        console.error('Error loading grades:', error);
                        tableBody.html('<tr><td colspan="5" style="color: red;">Could not load grades. Please try again later.</td></tr>');
                    }
                }

                // --- MODIFY THE EXISTING CLICK HANDLER ---
                // Find your existing nav click handler and add the 'else if' part
                $('.nav-links span').on('click', function () {
                    const targetId = $(this).data('target');

                    $('.section').removeClass('active');
                    $('#' + targetId).addClass('active');

                    if (targetId === 'accountsSection') {
                        loadStudentAccounts();
                    } else if (targetId === 'scheduleSection') {
                        loadStudentSchedule();
                    } else if (targetId === 'gradesSection') { // <-- ADD THIS BLOCK
                        loadStudentGrades();
                    }
                });

                // (Your enrollment functions would go here too, I've left them out for brevity)

                // --- EVENT HANDLERS ---

                // Navigation click handler
                $('.nav-links span').on('click', function () {
                    const targetId = $(this).data('target');

                    // Switch active class for section visibility
                    $('.section').removeClass('active');
                    $('#' + targetId).addClass('active');

                    // Load data for the selected section
                    if (targetId === 'accountsSection') {
                        loadStudentAccounts();
                    } else if (targetId === 'scheduleSection') {
                        loadStudentSchedule();
                    } else if (targetId === 'enrollmentSection') {
                        // loadStudentEnrollments();
                    }
                });

                loadStudentAccounts();
                loadStudentSchedule();
            });
        </script>

</body>

</html>