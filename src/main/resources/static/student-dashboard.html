<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Student Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #f6f7fb;
            color: #222;
        }
        header {
            background: #e74c3c;
            color: #fff;
            padding: 18px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .logo {
            font-size: 1.5em;
            font-weight: bold;
            letter-spacing: 1px;
        }
        nav {
            display: flex;
            gap: 18px;
        }
        nav .nav-link {
            color: #fff;
            text-decoration: none;
            font-weight: 500;
            padding: 8px 18px;
            border-radius: 6px;
            transition: background 0.2s;
        }
        nav .nav-link.active, nav .nav-link:hover {
            background: #fff;
            color: #e74c3c;
        }
        .container {
            display: flex;
            gap: 32px;
            max-width: 1300px;
            margin: 32px auto 0 auto;
            padding: 0 16px 32px 16px;
        }
        .sidebar {
            width: 260px;
            min-width: 200px;
        }
        .sidebar .card {
            padding: 18px 20px 18px 20px;
            margin-bottom: 24px;
        }
        .sidebar h4 {
            margin: 0 0 12px 0;
            font-size: 1.1em;
            color: #e74c3c;
        }
        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0 0 18px 0;
        }
        .sidebar ul li {
            margin-bottom: 10px;
        }
        .sidebar ul li a {
            color: #e74c3c;
            text-decoration: none;
            font-weight: 500;
            transition: text-decoration 0.2s;
        }
        .sidebar ul li a:hover {
            text-decoration: underline;
        }
        .inbox-list {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 1px 6px rgba(0,0,0,0.04);
            padding: 16px 0 0 0;
            margin-bottom: 18px;
        }
        .inbox-list .inbox-item {
            padding: 12px 20px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.98em;
        }
        .inbox-list .inbox-item:last-child {
            border-bottom: none;
        }
        .main-content {
            flex: 1;
            min-width: 0;
        }
        .card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            padding: 28px 32px 24px 32px;
            margin-bottom: 32px;
        }
        .alert {
            background: #fdeaea;
            color: #c0392b;
            border: 1px solid #f5b7b1;
            border-radius: 8px;
            padding: 16px 20px;
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .alert .icon {
            font-size: 1.5em;
        }
        h1 {
            font-size: 2em;
            font-weight: bold;
            margin: 0 0 18px 0;
        }
        h2, h3 {
            color: #e74c3c;
            margin-top: 0;
        }
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: #fff;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 1px 6px rgba(0,0,0,0.04);
            margin-bottom: 24px;
        }
        th, td {
            padding: 14px 12px;
            text-align: left;
        }
        th {
            background: #f6f7fb;
            color: #e74c3c;
            font-weight: 600;
            border-bottom: 2px solid #e74c3c22;
        }
        tr:nth-child(even) td {
            background: #fafbfc;
        }
        tr:last-child td {
            border-bottom: none;
        }
        .note {
            background: #fffbe6;
            color: #b8860b;
            border: 1px solid #ffe58f;
            border-radius: 8px;
            padding: 12px 18px;
            margin: 18px 0 0 0;
            font-size: 0.98em;
        }
        @media (max-width: 1000px) {
            .container { flex-direction: column; gap: 0; }
            .sidebar { width: 100%; min-width: 0; margin-bottom: 24px; }
        }
        @media (max-width: 700px) {
            .card { padding: 10px 2px 10px 2px; }
            th, td { padding: 8px 4px; }
        }
    </style>
</head>

<body>
    <header>
        <span class="logo">PRISM</span>
    <nav>
            <a class="nav-link active" href="student-dashboard.html">Home</a>
            <a class="nav-link" href="enrollment.html">Enrollment</a>
            <a class="nav-link" href="schedule.html">Schedule</a>
            <a class="nav-link" href="grades.html">Grades</a>
        </nav>
        <div style="display: flex; align-items: center; gap: 16px; position: relative;">
            <span id="profileIcon" style="font-size: 1.2em; cursor: pointer;">ðŸ‘¤</span>
            <div id="logoutDropdown" style="display:none; position:absolute; top:36px; right:0; background:#fff; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.12); min-width:120px; z-index:10;">
                <button id="logoutBtn" style="width:100%; background:#e74c3c; color:#fff; border:none; border-radius:8px; padding:10px 0; font-size:1em; cursor:pointer;">Logout</button>
            </div>
        </div>
    </header>
    <div class="container">
        <aside class="sidebar">
            <div class="card">
                <h4>Inbox</h4>
                <div class="inbox-list">
                    <div class="inbox-item"><b>March 08, 2025</b><br>2025 Career Fest (PI)</div>
                    <div class="inbox-item"><b>November 11, 2024</b><br>A Comprehensive Online Labor Laws and Standards Orientation and Review</div>
                    <div class="inbox-item"><b>May 14, 2024</b><br>Career Development Talk 2024</div>
                </div>
                <ul>
                    <li><a href="#">Graduation Clearance</a></li>
                    <li><a href="#">Submit Feedback</a></li>
                </ul>
            </div>
        </aside>
        <section class="main-content">
            <div class="card">
                <h1>Home</h1>
                <div style="margin-bottom: 18px;">
                    <span id="student-info" style="color:#e74c3c; font-weight:600;"></span>
                </div>
                <div class="alert">
                    <span class="icon">ðŸ“„</span>
                    <div>
                        <b>PRISM Internship Memorandum of Agreement</b><br>
                        Please review and download the required document
                    </div>
                </div>
                <div class="card" style="background:#f9f9f9; box-shadow:none;">
                    <h3 style="color:#222;">GENERAL GUIDELINES FOR IMPLEMENTATION OF RA 10931 - UNIVERSAL ACCESS TO QUALITY TERTIARY EDUCATION IN PRISM</h3>
                    <ol style="margin-left: 18px;">
                        <li>As stated in the Act, a student who has satisfied the admission requirements shall be eligible in availing Free Education provided that the student does not fall in the identified "ineligible" stated in Rule II Section 6 'Exceptions for Free HE'.</li>
                        <li>For a student to enjoy continued Free Education benefits, he/she must have good scholastic standing. However, the matrix below shows the action to be taken when students have scholastic delinquency.</li>
                    </ol>
                    <div style="overflow-x:auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th colspan="3">For 21 units and above load in previous semester</th>
                                </tr>
                                <tr>
                                    <th>NUMBER OF SUBJECT FAILED/WITHDRAWN/DROPPED</th>
                                    <th>ACTION TO BE TAKEN</th>
                                    <th>REMARKS</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>1 subject</td><td>Warning</td><td>Warning*</td></tr>
                                <tr><td>2 subjects</td><td>Warning with reduced load by 3 units</td><td>Warning*</td></tr>
                                <tr><td>3 subjects</td><td>Reduced load by 6 units</td><td>Scholarship will be forfeited for the following semester (Paying)</td></tr>
                                <tr><td>4 subjects</td><td>Dismissal-Dropped from the University</td><td></td></tr>
                            </tbody>
                        </table>
                        <table>
                            <thead>
                                <tr>
                                    <th colspan="3">For 20 units and below load in previous semester</th>
                                </tr>
                                <tr>
                                    <th>NUMBER OF SUBJECT FAILED/WITHDRAWN/DROPPED</th>
                                    <th>ACTION TO BE TAKEN</th>
                                    <th>REMARKS</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>1-2 subjects</td><td>Warning</td><td>Warning*</td></tr>
                                <tr><td>3 subjects</td><td>Warning with reduced load by 3 units</td><td>Scholarship will be forfeited for the following semester (Paying)</td></tr>
                                <tr><td>4 subjects</td><td>Dismissal-Dropped from the University</td><td></td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="note">
                        <b>Note:</b> Student who acquired a "Warning" for two consecutive semesters, the scholarship grant will be forfeited the following semester.
                    </div>
                    <ol style="margin-left: 18px; margin-top: 18px;">
                        <li>If a student stays beyond the allowed number of years according to the curriculum, the remaining years of stay, provided that this is still within the residency period.</li>
                        <li>In case a student intends to file a leave of absence, the same procedure shall be followed as stated in the PRISM Student Handbook. With permission from the University, the leave of absence will enable the student to still enjoy the scholarship on his/her return to the university.</li>
                        <li>Existing admission, retention, and graduation rules and policy of the University shall be upheld. They shall be used as a basis to complement the implementation of the Act.</li>
                        <li>For provisions inconsistent with the PRISM Student Handbook, the proposed guidelines shall prevail.</li>
                    </ol>
                </div>
        </div>
            <div class="card">
            <h2>Enrollment</h2>
                <p>Your enrolled subjects.</p>
            <hr>
            <div id="enrolledSubjectsContainer" style="margin-top:1.5rem;">
              <table id="enrolledSubjectsTable" style="width:100%; border-collapse:collapse; background:#fff; border-radius:10px; box-shadow:0 1px 6px rgba(0,0,0,0.04);">
                <thead>
                  <tr style="background:#ffeaea; color:#e85743;">
                    <th style="padding:10px 8px;">Subject Code</th>
                    <th style="padding:10px 8px;">Subject Name</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
        </div>
            <div class="card">
            <h2>My Class Schedule</h2>
            <p>Here is your schedule for the current semester.</p>
                <table>
                <thead>
                    <tr>
                        <th>Subject Code</th>
                        <th>Subject Name</th>
                        <th>Units</th>
                        <th>Room Number</th>
                        <th>Time</th>
                        <th>Day(s)</th>
                        <th>Faculty</th>
                    </tr>
                </thead>
                    <tbody id="scheduleTableBody"></tbody>
            </table>
        </div>
            <div class="card">
            <h2>My Grades</h2>
            <p>Your academic performance will be shown here once available.</p>
                <table>
                <thead>
                    <tr>
                        <th>Faculty</th>
                        <th>Course Code</th>
                        <th>Course Name</th>
                        <th>Grade</th>
                        <th>Comments</th>
                    </tr>
                </thead>
                    <tbody id="gradesTableBody"></tbody>
            </table>
            </div>
        </section>
    </div>
    <footer style="background:#fff; color:#888; font-size:0.98em; text-align:center; padding:18px 0 8px 0; border-top:1px solid #eee; margin-top:32px;">
        <div style="max-width:1200px; margin:auto; display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; gap:12px;">
            <div>For questions and comments, email us at <a href="mailto:prismconcerns@university.edu.ph" style="color:#e74c3c;">prismconcerns@university.edu.ph</a></div>
            <div>PRISM â€“ Portal for Records, Information, and Student Management</div>
            <div>
                <a href="#" style="color:#e74c3c; margin-right:8px;">Terms of Use</a>
                <a href="#" style="color:#e74c3c; margin-right:8px;">Privacy Statement</a>
                Version 06.2025.A
            </div>
        </div>
    </footer>
        <script>
            // --- SINGLE SOURCE OF TRUTH FOR STUDENT ID ---
            const studentId = sessionStorage.getItem("studentId");

            // Redirect if not logged in
            if (!studentId) {
                alert("You are not logged in. Redirecting to login page...");
                window.location.href = "login.html";
            }

            // --- COMBINED AND CLEANED-UP SCRIPT ---
            $(document).ready(function () {

                // --- ALL API-LOADING FUNCTIONS ---

                // Function to load student's schedule (unified with schedule.html)
                async function loadStudentSchedule() {
                    const tableBody = $('#scheduleTableBody');
                    tableBody.html('<tr><td colspan="7">Loading schedule...</td></tr>');
                    
                    // Get studentId and validate it
                    const studentId = sessionStorage.getItem("studentId");
                    if (!studentId) {
                        tableBody.html('<tr><td colspan="7" style="color:red;">Error: Student ID not found. Please log in again.</td></tr>');
                        console.error('Student ID not found in sessionStorage');
                        return;
                    }
                    
                    try {
                        const response = await fetch(`http://localhost:8080/api/enrollments/student/${studentId}`);
                        if (!response.ok) throw new Error('Failed to fetch enrollments from server.');

                        const enrollments = await response.json();
                        tableBody.empty(); // Clear the loading message

                        // Filter to only active enrollments (not dropped/deleted)
                        const active = enrollments.filter(e => !e.status || !['deleted','dropped'].includes(e.status.toLowerCase()));
                        
                        if (active.length === 0) {
                            tableBody.html('<tr><td colspan="7">No schedule found.</td></tr>');
                        } else {
                            active.forEach(enrollment => {
                                const row = `
                                <tr>
                                    <td>${enrollment.subjectCode || ''}</td>
                                    <td>${enrollment.subjectName || ''}</td>
                                    <td>${enrollment.units != null ? enrollment.units : ''}</td>
                                    <td>${enrollment.roomNumber || ''}</td>
                                    <td>${enrollment.time || ''}</td>
                                    <td>${enrollment.days || ''}</td>
                                    <td>${enrollment.facultyName || ''}</td>
                                </tr>`;
                                tableBody.append(row);
                            });
                        }
                    } catch (error) {
                        console.error('Error loading schedule:', error);
                        tableBody.html('<tr><td colspan="7" style="color: red;">Could not load schedule. Please try again later.</td></tr>');
                    }
                }

                async function loadStudentGrades() {
                    const tableBody = $('#gradesTableBody');
                    tableBody.html('<tr><td colspan="5">Loading grades...</td></tr>');
                    
                    // Get studentId and validate it
                    const studentId = sessionStorage.getItem("studentId");
                    if (!studentId) {
                        tableBody.html('<tr><td colspan="5" style="color:red;">Error: Student ID not found. Please log in again.</td></tr>');
                        console.error('Student ID not found in sessionStorage');
                        return;
                    }
                    
                    console.log('Using studentId:', studentId); // Debug log
                    
                    try {
                        // Fetch student info to get courseId
                        const studentRes = await fetch(`http://localhost:8080/api/admin/student/${studentId}`);
                        if (!studentRes.ok) throw new Error('Failed to fetch student info');
                        const student = await studentRes.json();
                        const courseId = student.course ? student.course.id : null;
                        
                        // Fetch enrollments, grades, and curriculum subjects in parallel
                        const [enrollmentsRes, gradesRes, curriculumRes, schedulesRes] = await Promise.all([
                            fetch(`http://localhost:8080/api/enrollments/student/${studentId}`),
                            fetch(`http://localhost:8080/api/grades/student/${studentId}`),
                            courseId ? fetch(`http://localhost:8080/api/curriculum-subjects/course/${courseId}`) : Promise.resolve({ ok: false }),
                            fetch(`http://localhost:8080/api/schedules/student/${studentId}`)
                        ]);
                        if (!enrollmentsRes.ok) throw new Error('Failed to fetch enrollments');
                        if (!gradesRes.ok) throw new Error('Failed to fetch grades');
                        if (!curriculumRes.ok) throw new Error('Failed to fetch curriculum subjects');
                        if (!schedulesRes.ok) throw new Error('Failed to fetch schedules');
                        const enrollments = await enrollmentsRes.json();
                        const grades = await gradesRes.json();
                        console.log('Enrollments:', enrollments);
                        console.log('Grades:', grades);
                        const curriculumSubjects = courseId && curriculumRes.ok ? await curriculumRes.json() : [];
                        const schedules = await schedulesRes.json();
                        console.log('Schedules:', schedules);
                        console.log('Schedule objects details:', schedules.map(s => ({
                            courseCode: s.courseCode,
                            subjectCode: s.subjectCode,
                            facultyName: s.facultyName,
                            faculty: s.faculty
                        })));
                        
                        // Build a map for faculty lookup by courseCode and subjectCode
                        const facultyMap = {};
                        schedules.forEach(s => {
                            const facultyName = s.facultyName || (s.faculty ? s.faculty.fullName : '') || '';
                            if (s.courseCode) {
                                facultyMap[s.courseCode] = facultyName;
                            }
                            if (s.subjectCode) {
                                facultyMap[s.subjectCode] = facultyName;
                            }
                        });
                        console.log('Faculty map:', facultyMap);
                        tableBody.empty();
                        // Build a map for quick grade lookup by courseCode+courseName
                        const gradeMap = {};
                        grades.forEach(g => {
                            const key = (g.courseCode || g.subjectCode || '') + '|' + (g.courseName || g.subjectName || '');
                            gradeMap[key] = g;
                        });
                        // Filter to unique subjects by code+name and only show active ones
                        const unique = {};
                        enrollments.forEach(e => {
                            if (e.status && (e.status.toLowerCase() === 'dropped' || e.status.toLowerCase() === 'deleted')) return;
                            const key = (e.courseCode || e.subjectCode || '') + '|' + (e.courseName || e.subjectName || '');
                            if (!unique[key]) unique[key] = e;
                        });
                        const uniqueEnrollments = Object.values(unique);
                        if (uniqueEnrollments.length === 0) {
                            tableBody.html('<tr><td colspan="5">No enrolled subjects.</td></tr>');
                        } else {
                            uniqueEnrollments.forEach(e => {
                                const key = (e.courseCode || e.subjectCode || '') + '|' + (e.courseName || e.subjectName || '');
                                const grade = gradeMap[key];
                                const facultyName = facultyMap[e.courseCode] || facultyMap[e.subjectCode] || '';
                                console.log(`Enrollment: ${e.courseCode || e.subjectCode}, Faculty lookup: ${facultyName}`);
                                const gradeValue = grade ? `<strong>${grade.grade}</strong>` : '<span style="color:#e74c3c;">Not graded yet</span>';
                                const comments = grade ? (grade.comments || '') : '';
                                const row = `
                                    <tr>
                                        <td>${facultyName}</td>
                                        <td>${e.courseCode || e.subjectCode || ''}</td>
                                        <td>${e.courseName || e.subjectName || ''}</td>
                                        <td>${gradeValue}</td>
                                        <td>${comments}</td>
                                    </tr>`;
                                tableBody.append(row);
                            });
                        }
                    } catch (error) {
                        console.error('Error loading grades:', error);
                        tableBody.html('<tr><td colspan="5" style="color: red;">Could not load grades. Please try again later.</td></tr>');
                    }
                }

                // --- EVENT HANDLERS ---

                // Navigation click handler
                $('.nav-links span').on('click', function () {
                    const targetId = $(this).data('target');

                    // Switch active class for section visibility
                    $('.section').removeClass('active');
                    $('#' + targetId).addClass('active');

                    // Load data for the selected section
                    if (targetId === 'scheduleSection') {
                        loadStudentSchedule();
                    } else if (targetId === 'gradesSection') {
                        loadStudentGrades();
                    }
                });

                loadStudentSchedule();
                loadStudentGrades();

                // Dynamically load student name and number
                if (studentId) {
                    fetch(`http://localhost:8080/api/admin/student/${studentId}`)
                        .then(res => res.json())
                        .then(data => {
                            if (data.name && data.studentNumber) {
                                let info = `${data.name} (${data.studentNumber})`;
                                if (data.course) {
                                    info += ` - ${data.course.code} (${data.course.name})`;
                                }
                                document.getElementById('student-info').textContent = info;
                            } else {
                                document.getElementById('student-info').textContent = 'Student';
                            }
                        })
                        .catch(() => {
                            document.getElementById('student-info').textContent = 'Student';
                        });
                }

                // Profile icon dropdown logic
                const profileIcon = document.getElementById('profileIcon');
                const logoutDropdown = document.getElementById('logoutDropdown');
                profileIcon.addEventListener('click', function(e) {
                    logoutDropdown.style.display = logoutDropdown.style.display === 'block' ? 'none' : 'block';
                    e.stopPropagation();
                });
                document.addEventListener('click', function() {
                    logoutDropdown.style.display = 'none';
                });
                document.getElementById('logoutBtn').addEventListener('click', function() {
                    sessionStorage.clear();
                    window.location.href = 'login.html';
                });

                // --- ENROLLED SUBJECTS LOGIC ---
                async function showEnrolledSubjectsForLoggedInStudent() {
                    const tableBody = $('#enrolledSubjectsTable tbody');
                    tableBody.html('<tr><td colspan="2" style="text-align:center; color:#888;">Loading enrolled subjects...</td></tr>');
                    // Get studentId and validate it
                    const studentId = sessionStorage.getItem("studentId");
                    if (!studentId) {
                        tableBody.html('<tr><td colspan="2" style="color:red;">Error: Student ID not found. Please log in again.</td></tr>');
                        console.error('Student ID not found in sessionStorage');
                        return;
                    }
                    try {
                        const res = await fetch(`/api/enrollments/student/${studentId}`);
                        const enrollments = await res.json();
                        console.log('Raw enrollments:', enrollments);
                        // Filter to unique subjects by code+name and only show active ones
                        const unique = {};
                        enrollments.forEach(e => {
                            if (e.status && (e.status.toLowerCase() === 'dropped' || e.status.toLowerCase() === 'deleted')) {
                                console.log('Filtered out (deleted/dropped):', e);
                                return;
                            }
                            const key = (e.courseCode || e.subjectCode || '') + '|' + (e.courseName || e.subjectName || '');
                            if (!unique[key]) unique[key] = e;
                        });
                        const uniqueEnrollments = Object.values(unique);
                        console.log('Unique enrollments to display:', uniqueEnrollments);
                        if (uniqueEnrollments.length === 0) {
                            tableBody.html('<tr><td colspan="2" style="text-align:center; color:#888;">No enrolled subjects.</td></tr>');
                        } else {
                            tableBody.html(
                                uniqueEnrollments.map(e =>
                                    `<tr><td style='padding:10px 8px; text-align:left;'>${e.courseCode || e.subjectCode || ''}</td><td style='padding:10px 8px; text-align:left;'>${e.courseName || e.subjectName || ''}</td></tr>`
                                ).join('')
                            );
                        }
                    } catch {
                        tableBody.html('<tr><td colspan="2" style="text-align:center; color:#e85743;">Failed to load enrolled subjects.</td></tr>');
                    }
                }
                // Call on page load
                showEnrolledSubjectsForLoggedInStudent();
            });
        </script>
</body>

</html>